# 前端自测方法文档

## 准备工作

1. 有个笔记本电脑且能连CMBC-T（最好是Mac，这样iPhone和Android都能调；如果是Windows，那最好配个Android手机）。
2. 下载、安装Charles代理软件（MacOS/Windows均有）。
3. 
   - 如果是Mac，可以装Xcode，并clone iOS代码来运行iOS Simulators（这样你就有一台虚拟iPhone了）。
   - 无论Mac还是Windows都可以装Android Studio，并clone Android代码来为自己Android手机打包了。
4. clone前端代码，仓库地址`git-server:fe/static_resources`。

## 初始配置

> 此处以Mac举例、Windows类似。

1. 从附件获取Charles.java，将其移动至Charles的安装目录下的`/应用程序/Charles.app/Contents/Java/`路径并覆盖掉原文件，Windows的路径是`···/Charles/lib/`（想买正版请忽略这一步😊 ​​）。

2. 打开Charles，自己可以慢慢摸索使用，这里只讲如何让自己调试。首先安装根证书：

![image-20180919171222019](/Users/panhui/Library/Application Support/typora-user-images/image-20180919171222019.png)

点击后会看到如下界面：

![image-20180919171603255](/Users/panhui/Library/Application Support/typora-user-images/image-20180919171603255.png)

这时双击它，选择“始终信任”后关闭（一般要验证密码），就可以了：

![image-20180919171711394](/Users/panhui/Library/Application Support/typora-user-images/image-20180919171711394.png)

（如果是Windows系统，应该会有一个证书安装的向导，在如下这一步请选择“受信任的根证书颁发机构”，如下图：）

![image-20180919171821743](/Users/panhui/Library/Application Support/typora-user-images/image-20180919171821743.png)

3. 代理设置，选择`Proxy->Proxy Settings…`，如下图：

![image-20180919172046880](/Users/panhui/Library/Application Support/typora-user-images/image-20180919172046880.png)

![image-20180919172131330](/Users/panhui/Library/Application Support/typora-user-images/image-20180919172131330.png)

在`HTTP Proxy`中的`Port`中填入端口号（默认8888），并勾选`Enable transparent HTTP proxying`，然后`OK`。

4. SSL代理设置：

   ![image-20180919172842763](/Users/panhui/Library/Application Support/typora-user-images/image-20180919172842763.png)

   在界面中点击`Add`填写要代理的域名和端口号，如图（我只填了UAT和SIT的地址，其他服务器地址类似）：

   ![image-20180919173014202](/Users/panhui/Library/Application Support/typora-user-images/image-20180919173014202.png)

5. 本地映射，如图：

   ![image-20180919182926489](/Users/panhui/Library/Application Support/typora-user-images/image-20180919182926489.png)

   勾选`Enable Map Local`，点击`add`添加规则（我这里拿SIT静态资源地址举例），`Local path`选择本地的代码`···/static_resources/src`：：

   ![image-20180919183021457](/Users/panhui/Library/Application Support/typora-user-images/image-20180919183021457.png)

   这样，请求向服务器的静态资源就会被映射至本地的文件，本地文件一修改、保存，页面一刷新就能立即看到效果（**如果要调试服务器上的静态资源而不是本地的，请取消这一步的本地映射！**）。

6. 如果是真机调试，请先将手机和笔记本电脑都连至CMBC-T，然后点击如图：

   ![image-20180919172648997](/Users/panhui/Library/Application Support/typora-user-images/image-20180919172648997.png)

   这时会出现一个提示：![image-20180919173106607](/Users/panhui/Library/Application Support/typora-user-images/image-20180919173106607.png)

   这时将自己手机的CMBC-T的代理设置成手动，代理主机和端口号分别填写你电脑提示的（其实就是你电脑的ip和刚才设置的端口号）：

   ![image-20180919173323821](/Users/panhui/Library/Application Support/typora-user-images/image-20180919173323821.png)

   配置完后，电脑会有个联入的提示，选择`Allow`。（真机的弊端是笔记本电脑有时连CMBC-T，电脑的ip会变，如果发现不能用需要去改变手机的代理主机）





## 开始调试

1. 打开App，打开想调试的页面，你会在Charles中发现如下结构（请用下方Filter过滤，规则写cmbc就行）：![image-20180919181515018](/Users/panhui/Library/Application Support/typora-user-images/image-20180919181515018.png)

2. **如果做了本地映射的话**，尝试修改本地文件、保存，刷新页面，即可看到效果。

3. 如果你是iPhone+Windows，那目前只能这样了。

   但这样似乎只能看效果，而无法debug（虽说在开发机上可以调试页面甚至接口，但你总是无法完美模拟手机显示器的区域面积，无法调试jsBridge，以及第三方的页面）。


4. 但如果你是Android手机（无论什么电脑但前提要已经翻墙），可以先让Android开发同事打一个能够对webview进行debug的包（安卓代码添加：`WebView.setWebContentsDebuggingEnabled(true);`，并且打出来的包最好能选服务器地址），再将手机连上电脑并且开启开发者模式+USB调试，然后打开电脑的Chrome，地址栏输入“`chrome://inspect`”，你就会看到如下图所示，Chrome探测到了你的手机：

   ![image-20180920084911468](/Users/panhui/Library/Application Support/typora-user-images/image-20180920084911468.png)

   然后打开App，打开你想调试的页面，你会在Chrome中看到如下图的webview探测提示，点击`inspect`：![image-20180920085413631](/Users/panhui/Library/Application Support/typora-user-images/image-20180920085413631.png)

   然后你就会看到一个类似Chrome的Dev Tools的工具出现了如下图，点击箭头所指的`Toggle Screencast`可以切换是否需要截屏（也就是是否显示左侧区域）。如果你电脑没出现，说明你需要翻墙，因为第一次要下载Google的某些组件工具，之后就不用翻墙了（不同版本的webview都需要单独下载，也就是说换了个手机很有可能要再下载Google组件；而且有些电脑会自动清理这些组件，尚不清楚是何原因，如果某次发现又打不开，请再次翻墙）。

   ![image-20180920085812799](/Users/panhui/Library/Application Support/typora-user-images/image-20180920085812799.png)

   接下来，有了Dev Tools，你该会debug了吧😊。

5. 如果你是Mac电脑，恭喜你，你还能进行iPhone的调试（真机或者模拟器都行，以下拿模拟器举例）。首先你要clone iOS的代码到笔记本电脑并且安装了Xcode，之后请iOS同事帮你捣鼓一番（朱昊🤪）（具体我就不清楚了，Xcode的的操作自己摸索吧），然后选择一个simulator：![image-20180920091631723](/Users/panhui/Library/Application Support/typora-user-images/image-20180920091631723.png)

   然后`cmd+R`Build+Run，然后你就得到了一台（假的）iphone XS Max🤓：![image-20180920091825923](/Users/panhui/Library/Application Support/typora-user-images/image-20180920091825923.png)

   像真机一样去操作它，打开要调试的页面（有些需要安全键盘输入的，要用鼠标去点击安全键盘输入，其他一般的input用电脑键盘输入即可），打开Safari，（如果你的Safari没有"开发"菜单，请`cmd+,`打开偏好设置，然后如图勾选：）![image-20180920093014656](/Users/panhui/Library/Application Support/typora-user-images/image-20180920093014656.png)
   然后如图操作：![image-20180920092917574](/Users/panhui/Library/Application Support/typora-user-images/image-20180920092917574.png)

   你就能看到Safari的开发者工具了：![image-20180920093238161](/Users/panhui/Library/Application Support/typora-user-images/image-20180920093238161.png)

   接下来的debug，就不用多说了😊。

6. 如果你想用Mac上的模拟器去做本地映射（`Map Local`）的话，在Charles中开启`macOS Proxy`，快捷键`shift+cmd+P`。开启本机代理之后，向模拟器安装根证书，如图点击：![image-20180920093501983](/Users/panhui/Library/Application Support/typora-user-images/image-20180920093501983.png)

   将根证书装进iOS模拟器里（如果电脑经常切换CMBC-CC2和CMBC-T，那可能要多点几次），接下来就如之前说真机本地映射一样了。​

